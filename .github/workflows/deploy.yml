name: Deploy Capydam

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # 1. Stop on any error
            set -e

            # 2. Navigate to project folder
            cd /var/www/capydam

            # ‚úÖ 3. FORCE RESET LOCAL STATE
            # This discards the modified package-lock.json and any other local debris
            echo "üßπ Resetting local environment to match remote..."
            git fetch origin main
            git reset --hard origin/main

            # ‚úÖ 4. BACKEND: Strict Install & Migration
            echo "üõ†Ô∏è Building Backend..."
            cd server
            # 'npm ci' is safer than 'npm install' in production as it won't change the lockfile
            npm ci 
            npx prisma migrate deploy
            npx prisma generate
            npm run build
            cd ..

            # ‚úÖ 5. FRONTEND: Strict Install
            echo "üé® Building Frontend..."
            cd client
            npm ci
            npm run build
            cd ..

            # 6. Restart PM2 (Backend)
            echo "üîÑ Restarting Server..."
            pm2 restart capydam-api || pm2 start server/dist/index.js --name capydam-api
            pm2 save

            echo "‚úÖ Deployment Successful!"